<p style=""><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup_part_2_puppet_agent/puppet.png" style="width: 300px;"></p><h1 style="text-align: center;">Puppet Agent Setup</h1><p>So in this post I will run through the setup of puppet agent on two boxes. &nbsp;This will continue in from my last post. &nbsp;The first thing we need to do is bring up the two Ubuntu servers in Vagrant web01 and webtest01.</p><h2>Pre-req&#39;s</h2><p>I do this with Iterm2 so I can have two tabs open at the same time, so go ahead and run vagrant up in both the web01 and webtest01 folders to get the machines running. &nbsp;Once running ssh into them i.e.</p><p><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup_part_2_puppet_agent/Screen_Shot_2016-11-03_at_12.27.13_pm.png" style="width: 900px;"></p><p>I do and ifconfig to just confirm that the correct ip address are configured. &nbsp;You could also ping the puppet masters IP address to make sure they can talk to each other.</p><p>Once both boxes are up, we need to add a host file entry so that the DNS to puppetmaster works, now in production you have a DNS service that would do this for you.</p><p>Again sudo into su you have the rights to change the systems and do this to both boxes</p><p><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup_part_2_puppet_agent/Screen_Shot_2016-11-03_at_12.46.40_pm.png" style="width: 1020px;"></p><p><br></p><h2 style="">Installing and Configuring Puppet Agent</h2><p>Again we have to download the package and install from the Puppet site:</p><pre class="language-bash"><code>wget <a href="https://apt.puppetlabs.com/puppetlabs-release-pc1-xenial.deb">https://apt.puppetlabs.com/puppetlabs-release-pc1-xenial.deb</a>
dpkg -i puppetlabs-release-pc1-xenial.deb
apt update
apt install puppet</code></pre><p style="">Now we edit the puppet configuration so that it knows the name of the puppet master and remove the config for passenger:</p><pre class="language-bash"><code>nano /etc/puppet/puppet.conf</code></pre><p style="">Remove:</p><pre class="language-bash"><code># These are needed when the puppetmaster is run by passenger
# and can safely be removed if webrick is used.
ssl_client_header = SSL_CLIENT_S_DN
ssl_client_verify_header = SSL_CLIENT_VERIFY</code></pre><p style="">Add:</p><pre class="language-bash"><code>[agent]
server = puppetmaster</code></pre><p style="">Now we enable the agent and config the SSL certificates:</p><pre class="language-bash"><code>puppet agent --enable
puppet agent --verbose --no-daemonize --onetime</code></pre><p style=""><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup_part_2_puppet_agent/Screen_Shot_2016-11-03_at_1.16.54_pm.png" style="width: 1020px;"></p><p style="">Now we want to go back to the puppet master and sign the certificates, and this just requires to do another puppet command:</p><pre class="language-bash"><code>puppet cert list
puppet cert sign web01
puppet cert sign webtest01</code></pre><p style=""><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup_part_2_puppet_agent/Screen_Shot_2016-11-03_at_1.36.05_pm.png" style="width: 1020px;"></p><p style="">Now we want to test the connect from the agents again, run the same command and make sure the connect:</p><p style=""><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup_part_2_puppet_agent/Screen_Shot_2016-11-03_at_1.43.40_pm.png" style="width: 1040px;"></p><p><br></p><p style="">Now that this is done, the agent is now configured. &nbsp;The next steps which we will do in the next couple post will be to create manifests and modules to actually configure the servers.</p><p style=""><br></p><p style=""><br></p><p><br></p><p><br></p>