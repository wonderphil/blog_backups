<h1 style=""><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup/puppet.png" style="width: 300px;">Puppet Setup</h1><p>I wont go into why you should use Puppet over anything else, mainly because I use chef for my personal stuff and now use Puppet at work. &nbsp;Both are doing the same thing and that is leading to Infra-as-code, making it easy and repeatable to build you environments. &nbsp;Both have there pros and cons, and there are main others out there doing the same thing.</p><p><br></p><h2>Pre-req&#39;s</h2><p>So for this lab I am using <a href="https://www.vagrantup.com/" target="_blank">Vagrent</a> and <a href="https://www.virtualbox.org/" target="_blank">Virtual box</a>, so make sure you have them downloaded and installed. &nbsp;I am running all this off my mac, but can be done for Windows if needed.</p><p>In this lab I am going to have 3 boxes with the following hardware and network setup, note all machines need access to the internet:</p><table style="width: 100%;"><thead><tr><th style="width: 16.6667%;">Role<br></th><th style="width: 16.6667%;">Hostname<br></th><th style="width: 16.6667%;">OS<br></th><th style="width: 16.6667%;">Memory<br></th><th style="width: 16.6667%;">Hard Disk<br></th><th style="width: 16.6667%;">IP Address<br></th></tr></thead><tbody><tr><td style="width: 16.6667%;">Puppet Master<br></td><td style="width: 16.6667%;">puppet<br></td><td style="width: 16.6667%;">Ubuntu 16.04 LTS<br></td><td style="width: 16.6667%;">2GB<br></td><td style="width: 16.6667%;">16GB<br></td><td style="width: 16.6667%;">192.168.5.10/24<br></td></tr><tr><td style="width: 16.6667%;">Web Server<br></td><td style="width: 16.6667%;">web01<br></td><td style="width: 16.6667%;">Ubuntu 16.04 LTS<br></td><td style="width: 16.6667%;">2GB<br></td><td style="width: 16.6667%;">16GB<br></td><td style="width: 16.6667%;">192.168.5.11/24<br></td></tr><tr><td style="width: 16.6667%;">Web Server (Test)<br></td><td style="width: 16.6667%;">webtest01<br></td><td style="width: 16.6667%;">Ubuntu 16.04 LTS<br></td><td style="width: 16.6667%;">2GB<br></td><td style="width: 16.6667%;">16GB<br></td><td style="width: 16.6667%;">192.168.5.12/24<br></td></tr></tbody></table><p><br></p><p>Vagrant Images I downloaded from here: <a href="https://cloud-images.ubuntu.com/xenial/current/">https://cloud-images.ubuntu.com/xenial/current/</a></p><h2>Setup for Puppet Master</h2><ol><li>Clone my puppet lab git repo: <a href="https://github.com/wonderphil/puppet_lab">https://github.com/wonderphil/puppet_lab</a></li><li>Download the Vagrant image into the repo</li><li>Add the Vagrant Image<br><pre class="language-bash"><code>vagrant box add ubuntu_16 xenial-server-cloudimg-amd64-vagrant.box</code></pre></li><li>Then bring up the puppet master box <br><pre class="language-bash"><code>cd puppetmaster
vagrant up</code></pre></li><li>Now ssh to the box, so we can install puppet<pre class="language-bash"><code>vagrant ssh
sudo su -
apt-get update
apt-get install git ntp
service ntp start
update-rc.d ntp enable 2 3 4 5</code></pre>&nbsp;All we are doing here is changing the user over to su, then doing an apt-get update before we install git and NTP. &nbsp;Next we start NTP and configure it to start on startup.</li><li>Now we want to install puppet server, its best to go to <a href="https://docs.puppet.com/puppet/latest/reference/puppet_collections.html#apt-based-systems" target="_blank">puppet docs</a> and get the commands. &nbsp;For this lab I used the following as su: <br><pre class="language-bash"><code>wget <a href="https://apt.puppetlabs.com/puppetlabs-release-pc1-xenial.deb">https://apt.puppetlabs.com/puppetlabs-release-pc1-xenial.deb</a>
dpkg -i puppetlabs-release-pc1-xenial.deb
apt update
apt install puppetmaster
puppet master --version</code></pre></li></ol><p>This adds the puppet repo, updates and installs puppet server, then to make sure everything is ok I run <code>puppet master --version</code> to make sure its installed. If this doesn&#39;t error out you now have Puppet installed, next will be to configure the Puppet.</p><h2>Configure Puppet Master</h2><p>Now as you might of seen about I have two web boxes, one called web01 and the other webtest01. &nbsp;So one box is our production web server and the other is our testing web server. &nbsp;So to handle this the first thing we want to configure is the Environments folders. &nbsp;This is a really simple step of just adding folders on our puppet master.</p><h3><br></h3><h3>Environment Config</h3><p>On the puppet master there is going to be a environment config file and this controls the environment specific settings for the environment:</p><p class="fr-text-bordered" style="text-align: center;"><span style="background-color: rgb(204, 204, 204);">/etc/puppet/environments/</span><span style="background-color: rgb(247, 218, 100);">&#39;<em>environment name</em>&#39;</span><span style="background-color: rgb(204, 204, 204);">/environment.conf</span></p><p>Where &#39;environment name&#39; can be anything you want to describe the environment i.e. dev, test, staging, production.....</p><p>So for this lab lets create the folders that are required for our test and production environments:</p><pre class="language-bash"><code>mkdir -p /etc/puppet/environments/{production,test}/{modules,manifests}</code></pre><p style="">All we are doing here is creating a folder structure for both test and production and both of them have folders called modules and manifests.</p><p>In our environments folders for this lab we are going to create the environment.conf file with the following settings and this can be done with nano:</p><pre class="language-bash"><code>modulepath = /etc/puppet/environments/production/modules
environment_timeout =5s</code></pre><h3><br></h3><h3>The main puppet config</h3><p>The configure file is made up of 3 main sections, which are below with some of the config settings.</p><p><strong>[main]</strong></p><p>In this section you can have things like the log folder, pid folder or ssl folders defined i.e.</p><pre class="language-bash"><code>logdir = /var/log/puppet
rundir = /run/puppet
ssldir = $vardir/ssl</code></pre><p>These setting apply to both the master and the agent and thats why its called main.</p><p><strong>[master]</strong></p><p>Master holds all the settings &nbsp;to be applied to the master, these setting could include the Environments folders we just created or modules path i.e.</p><pre class="language-bash"><code>environmentspath = $confdir/$environments
basemodulepath = $confdir/modules:/opt/puppet/share/modules</code></pre><p>By default the $confdir is configured to point at /etc/puppet</p><p><strong>[agent]</strong></p><p>Then the agent section is for agent specific settings i.e.</p><pre class="language-bash"><code>classfile = $vardir/classes.txt
localconfig = $vardir/localconfig</code></pre><p style="">So now we will go through and make some changes to ours:</p><pre class="language-bash"><code>nano /etc/puppet/puppet.conf</code></pre><p>The main part that I add is in the <strong>[master]</strong> section:</p><pre class="language-bash"><code>environmentpath = $confdir/environments
basemodulepath = $confdir/modules:/opt/puppet/share/modules</code></pre><p>Then in the <strong>[main]</strong> part I like to add some DNS alterative names, this allows for future name changes of servers with out having to change files and configs everywhere:</p><pre class="language-bash"><code>dns_alt_names = puppet,puppetmaster,puppertmaster.phildavies.local</code></pre><h3><br></h3><h3>Puppet SSL Configuration and Generation</h3><p>The SSL is used to encrpyt traffice between the nodes and to stop agents connecting to just any puppet master. &nbsp;Generating the certificates only need to happen one time when setting up the master or when you need to revoke certificates for what ever reason. &nbsp;To generate we just run the following command:</p><pre class="language-bash"><code>puppet master --verbose --no-daemonize</code></pre><p>Now all we are doing here is running the service with its outputting its logs to the screen and not running as a service, when we look at the logs we see that it generate the certificates(in red), once you see the notice about puppet started(in blue) you can kill the service by pressing clt-c:</p><p style=""><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup/Screen_Shot_2016-11-02_at_4.18.42_pm.png" style="width: 1020px;"></p><p>Now you might find that you get an error about not being able to write to the pid file, if thats the case puppet is already running, at which point the SSL certificates are already created. &nbsp;So you could find the service, kill it(in blue), if you run the command now you wil see nothing comes up(in red), delete the SSL certificates(in yellow) and then re-run the command(in green):</p><p><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup/Screen_Shot_2016-11-02_at_4.26.00_pm.png" style="width: 1020px;"></p><p><br></p><h3>Setup Nginx, Unicorn and Systemd</h3><p>Now most people just use Passager and Apache, I&#39;m not a great fan of either so I will run through the steps of setting up Nginx - web server, Unicorn - App Server and Systemd to run the service.</p><h4 style=""><br></h4><h4 style="">Unicorn/Rack</h4><p style="">First I install unicorn and configure: (again still as su)</p><pre class="language-bash"><code>apt install unicorn</code></pre><p>Next we configure Unicorn and I have a config file in the Git repo from above, this can be pasted into <code class="language-bash">/etc/puppet/unicorn.rb</code></p><p>Second lets sort out the puppet service, we need to disable the SysVinit services from starting up, edit <code class="language-bash">/etc/default/puppetmaster</code> changing <code class="language-bash">START=yes</code> to <code class="language-bash">/START=no</code>. Then we want to stop puppetmaster by running <code class="language-bash">invoke-rc.d puppetmaster stop</code></p><p style="">Now we create our custom service, this too is in the git repo:</p><pre class="language-bash"><code>nano /etc/systemd/system/puppetmaster.service</code></pre><p style="">Paste the following:</p><pre class="language-bash"><code>[Unit]
Description=Puppet master unicorn server

[Service]
WorkingDirectory=/var/lib/puppet
SyslogIdentifier=puppetmaster-unicorn
PIDFile=/run/puppet/puppetmaster.pid

ExecStart=/usr/bin/unicorn -c /etc/puppet/unicorn.rb /usr/share/puppet/ext/rack/config.ru
ExecStop=/bin/kill -QUIT $MAINPID
#ExecReload=/bin/kill -USR1 $MAINPID

[Install]
WantedBy=multi-user.target
</code></pre><p style="">Next we want to create rack config file, if you copy from the git repo the<code class="language-bash">rack/config.ru</code> and put it on your puppet master server at <code class="language-bash">/usr/share/puppet/ext/rack/config.ru</code></p><p style="">Now we can load and start our service:</p><pre class="language-bash" style=""><code>systemctl --system daemon-reload</code>
systemctl start puppetmaster.service</pre><p style="">If you do a service puppetmaster status you should see the &quot;<span style="color: rgb(26, 188, 156);">active(running) since .....</span>&quot;</p><p style=""><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup/Screen_Shot_2016-11-03_at_9.49.22_am.png" style="width: 1020px;"></p><p style=""><br></p><h4 style="">Nginx</h4><p style="">Next lets install nginx, this is a really simple process:</p><pre class="language-bash"><code>apt install nginx</code></pre><p style="">The configuration of nginx is really simple, again copy from the git repo the puppetmaster nginx config file, adjust the path to the SSL certs and place in <code class="language-bash">/etc/nginx/sites-available path.</code></p><p style="">Create a symlink to sites-enabled and deleted default:</p><pre class="language-bash"><code>rm /etc/nginx/sites-enabled/default
ln -s /etc/nginx/sites-available/puppetmaster /etc/nginx/sites-enabled/puppetmaster</code></pre><p style="">Restart Nginx and make sure its running:</p><pre class="language-bash"><code>service nginx stop
service nginx start
service nginx status</code></pre><p style="">Last step is to remove some config from the puppet.conf file that&#39;s required for passenger. &nbsp;So go ahead and remove:</p><pre class="language-bash"><code>ssl_client_header = SSL_CLIENT_S_DN
ssl_client_verify_header = SSL_CLIENT_VERIFY</code></pre><p style="">Now lets make sure puppet agent works:</p><pre class="language-bash"><code>service puppetmaster restart
puppet agent --enable
puppet agent --test</code></pre><p style="">You should hope to see:</p><p style=""><img class="fr-dib fr-draggable" src="/uploads/blogs/automation_of_server_builds/puppet_setup/Screen_Shot_2016-11-03_at_10.31.49_am.png" style="width: 1020px;"></p><p style=""><br></p><p style="">Ok you now have Puppet master up and running and with a production ready Web/App server. &nbsp;In the next blog I will go into Puppet agent setup.</p><p style=""><br></p><p style=""><br></p><p style=""><br></p><p style=""><br></p><p style=""><br></p><p style=""><br></p><p style=""><br></p>